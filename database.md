-- WARNING: This schema is for context only and is not meant to be run.
-- Table order and constraints may not be valid for execution.

CREATE TABLE public.activity_logs (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  user_id uuid,
  action character varying NOT NULL,
  entity_type character varying,
  entity_id uuid,
  metadata jsonb,
  ip_address inet,
  user_agent text,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT activity_logs_pkey PRIMARY KEY (id),
  CONSTRAINT activity_logs_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.profiles(id)
);
CREATE TABLE public.addresses (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  user_id uuid,
  title character varying NOT NULL,
  address_line_1 character varying NOT NULL,
  address_line_2 character varying,
  city character varying NOT NULL,
  state character varying,
  postal_code character varying,
  country character varying DEFAULT 'Morocco'::character varying,
  latitude numeric,
  longitude numeric,
  is_default boolean DEFAULT false,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT addresses_pkey PRIMARY KEY (id),
  CONSTRAINT addresses_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.profiles(id)
);
CREATE TABLE public.booking_tracking (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  booking_id uuid,
  worker_id uuid,
  status character varying NOT NULL,
  location USER-DEFINED,
  notes text,
  estimated_completion timestamp with time zone,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT booking_tracking_pkey PRIMARY KEY (id),
  CONSTRAINT booking_tracking_booking_id_fkey FOREIGN KEY (booking_id) REFERENCES public.bookings(id),
  CONSTRAINT booking_tracking_worker_id_fkey FOREIGN KEY (worker_id) REFERENCES public.worker_profiles(id)
);
CREATE TABLE public.bookings (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  booking_number character varying NOT NULL UNIQUE,
  customer_id uuid,
  worker_id uuid,
  service_id uuid,
  status USER-DEFINED DEFAULT 'pending'::booking_status,
  scheduled_date date NOT NULL CHECK (scheduled_date >= CURRENT_DATE),
  scheduled_time time without time zone NOT NULL,
  estimated_duration integer NOT NULL,
  service_address_id uuid,
  service_location USER-DEFINED,
  service_address_text text NOT NULL,
  vehicle_type USER-DEFINED NOT NULL,
  vehicle_make character varying,
  vehicle_model character varying,
  vehicle_year integer,
  vehicle_color character varying,
  license_plate character varying,
  base_price numeric NOT NULL,
  additional_charges numeric DEFAULT 0.00,
  discount_amount numeric DEFAULT 0.00,
  total_price numeric NOT NULL CHECK (total_price >= 0::numeric),
  special_instructions text,
  customer_notes text,
  worker_notes text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  started_at timestamp with time zone,
  completed_at timestamp with time zone,
  cancelled_at timestamp with time zone,
  cancelled_by uuid,
  cancellation_reason text,
  can_cancel boolean DEFAULT true,
  can_reschedule boolean DEFAULT true,
  can_rate boolean DEFAULT false,
  CONSTRAINT bookings_pkey PRIMARY KEY (id),
  CONSTRAINT bookings_customer_id_fkey FOREIGN KEY (customer_id) REFERENCES public.profiles(id),
  CONSTRAINT bookings_worker_id_fkey FOREIGN KEY (worker_id) REFERENCES public.worker_profiles(id),
  CONSTRAINT bookings_service_id_fkey FOREIGN KEY (service_id) REFERENCES public.services(id),
  CONSTRAINT bookings_service_address_id_fkey FOREIGN KEY (service_address_id) REFERENCES public.addresses(id),
  CONSTRAINT bookings_cancelled_by_fkey FOREIGN KEY (cancelled_by) REFERENCES public.profiles(id)
);
CREATE TABLE public.conversations (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  booking_id uuid,
  customer_id uuid,
  worker_id uuid,
  last_message_at timestamp with time zone DEFAULT now(),
  is_active boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT conversations_pkey PRIMARY KEY (id),
  CONSTRAINT conversations_booking_id_fkey FOREIGN KEY (booking_id) REFERENCES public.bookings(id),
  CONSTRAINT conversations_customer_id_fkey FOREIGN KEY (customer_id) REFERENCES public.profiles(id),
  CONSTRAINT conversations_worker_id_fkey FOREIGN KEY (worker_id) REFERENCES public.profiles(id)
);
CREATE TABLE public.messages (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  conversation_id uuid,
  sender_id uuid,
  message_type USER-DEFINED DEFAULT 'text'::message_type,
  content text,
  media_url text,
  metadata jsonb,
  is_read boolean DEFAULT false,
  read_at timestamp with time zone,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT messages_pkey PRIMARY KEY (id),
  CONSTRAINT messages_conversation_id_fkey FOREIGN KEY (conversation_id) REFERENCES public.conversations(id),
  CONSTRAINT messages_sender_id_fkey FOREIGN KEY (sender_id) REFERENCES public.profiles(id)
);
CREATE TABLE public.notifications (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  user_id uuid,
  type USER-DEFINED NOT NULL,
  title character varying NOT NULL,
  message text NOT NULL,
  booking_id uuid,
  conversation_id uuid,
  data jsonb,
  action_url text,
  is_read boolean DEFAULT false,
  is_sent boolean DEFAULT false,
  push_token text,
  sent_at timestamp with time zone,
  read_at timestamp with time zone,
  created_at timestamp with time zone DEFAULT now(),
  expires_at timestamp with time zone,
  CONSTRAINT notifications_pkey PRIMARY KEY (id),
  CONSTRAINT notifications_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.profiles(id),
  CONSTRAINT notifications_booking_id_fkey FOREIGN KEY (booking_id) REFERENCES public.bookings(id),
  CONSTRAINT notifications_conversation_id_fkey FOREIGN KEY (conversation_id) REFERENCES public.conversations(id)
);
CREATE TABLE public.payments (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  booking_id uuid,
  customer_id uuid,
  worker_id uuid,
  amount numeric NOT NULL,
  currency character varying DEFAULT 'MAD'::character varying,
  payment_method USER-DEFINED NOT NULL,
  status USER-DEFINED DEFAULT 'pending'::payment_status,
  gateway_transaction_id character varying,
  gateway_reference character varying,
  gateway_response jsonb,
  platform_fee numeric DEFAULT 0.00,
  worker_earnings numeric NOT NULL,
  processed_at timestamp with time zone,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT payments_pkey PRIMARY KEY (id),
  CONSTRAINT payments_booking_id_fkey FOREIGN KEY (booking_id) REFERENCES public.bookings(id),
  CONSTRAINT payments_customer_id_fkey FOREIGN KEY (customer_id) REFERENCES public.profiles(id),
  CONSTRAINT payments_worker_id_fkey FOREIGN KEY (worker_id) REFERENCES public.worker_profiles(id)
);
CREATE TABLE public.profiles (
  id uuid NOT NULL,
  email character varying NOT NULL UNIQUE,
  phone character varying,
  full_name character varying NOT NULL,
  avatar_url text,
  role USER-DEFINED DEFAULT 'customer'::user_role,
  status USER-DEFINED DEFAULT 'active'::user_status,
  date_of_birth date,
  gender character varying,
  language_preference character varying DEFAULT 'en'::character varying,
  timezone character varying DEFAULT 'Africa/Casablanca'::character varying,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  last_seen_at timestamp with time zone DEFAULT now(),
  preferred_payment_method USER-DEFINED,
  loyalty_points integer DEFAULT 0,
  worker_license character varying,
  worker_rating numeric DEFAULT 0.00 CHECK (worker_rating >= 0::numeric AND worker_rating <= 5::numeric),
  worker_review_count integer DEFAULT 0,
  is_verified boolean DEFAULT false,
  background_check_status character varying,
  CONSTRAINT profiles_pkey PRIMARY KEY (id),
  CONSTRAINT profiles_id_fkey FOREIGN KEY (id) REFERENCES auth.users(id)
);
CREATE TABLE public.promotions (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  code character varying NOT NULL UNIQUE,
  title character varying NOT NULL,
  description text,
  discount_type character varying NOT NULL,
  discount_value numeric NOT NULL,
  max_discount_amount numeric,
  min_order_amount numeric,
  usage_limit integer,
  usage_count integer DEFAULT 0,
  per_user_limit integer DEFAULT 1,
  valid_from timestamp with time zone NOT NULL,
  valid_until timestamp with time zone NOT NULL,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT promotions_pkey PRIMARY KEY (id)
);
CREATE TABLE public.reviews (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  booking_id uuid UNIQUE,
  customer_id uuid,
  worker_id uuid,
  overall_rating integer NOT NULL CHECK (overall_rating >= 1 AND overall_rating <= 5),
  service_quality_rating integer CHECK (service_quality_rating >= 1 AND service_quality_rating <= 5),
  punctuality_rating integer CHECK (punctuality_rating >= 1 AND punctuality_rating <= 5),
  communication_rating integer CHECK (communication_rating >= 1 AND communication_rating <= 5),
  review_text text,
  photos ARRAY,
  is_verified boolean DEFAULT false,
  is_featured boolean DEFAULT false,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT reviews_pkey PRIMARY KEY (id),
  CONSTRAINT reviews_booking_id_fkey FOREIGN KEY (booking_id) REFERENCES public.bookings(id),
  CONSTRAINT reviews_customer_id_fkey FOREIGN KEY (customer_id) REFERENCES public.profiles(id),
  CONSTRAINT reviews_worker_id_fkey FOREIGN KEY (worker_id) REFERENCES public.worker_profiles(id)
);
CREATE TABLE public.services (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  key character varying NOT NULL UNIQUE,
  title character varying NOT NULL,
  description text,
  category USER-DEFINED NOT NULL,
  base_price numeric NOT NULL,
  duration_minutes integer NOT NULL,
  icon_name character varying,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  sedan_multiplier numeric DEFAULT 1.00,
  suv_multiplier numeric DEFAULT 1.20,
  van_multiplier numeric DEFAULT 1.40,
  truck_multiplier numeric DEFAULT 1.60,
  CONSTRAINT services_pkey PRIMARY KEY (id)
);
CREATE TABLE public.spatial_ref_sys (
  srid integer NOT NULL CHECK (srid > 0 AND srid <= 998999),
  auth_name character varying,
  auth_srid integer,
  srtext character varying,
  proj4text character varying,
  CONSTRAINT spatial_ref_sys_pkey PRIMARY KEY (srid)
);
CREATE TABLE public.user_promotions (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  user_id uuid,
  promotion_id uuid,
  booking_id uuid,
  used_at timestamp with time zone DEFAULT now(),
  CONSTRAINT user_promotions_pkey PRIMARY KEY (id),
  CONSTRAINT user_promotions_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.profiles(id),
  CONSTRAINT user_promotions_promotion_id_fkey FOREIGN KEY (promotion_id) REFERENCES public.promotions(id),
  CONSTRAINT user_promotions_booking_id_fkey FOREIGN KEY (booking_id) REFERENCES public.bookings(id)
);
CREATE TABLE public.worker_profiles (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  user_id uuid UNIQUE,
  business_name character varying,
  bio text,
  experience_years integer,
  specialties ARRAY,
  service_radius_km integer DEFAULT 10,
  base_location USER-DEFINED,
  current_location USER-DEFINED,
  status USER-DEFINED DEFAULT 'offline'::worker_status,
  hourly_rate numeric,
  commission_rate numeric DEFAULT 15.00,
  works_weekends boolean DEFAULT true,
  start_time time without time zone DEFAULT '08:00:00'::time without time zone,
  end_time time without time zone DEFAULT '18:00:00'::time without time zone,
  total_jobs_completed integer DEFAULT 0,
  total_earnings numeric DEFAULT 0.00,
  average_completion_time integer,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT worker_profiles_pkey PRIMARY KEY (id),
  CONSTRAINT worker_profiles_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.profiles(id)
);
CREATE TABLE public.worker_services (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  worker_id uuid,
  service_id uuid,
  custom_price numeric,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT worker_services_pkey PRIMARY KEY (id),
  CONSTRAINT worker_services_worker_id_fkey FOREIGN KEY (worker_id) REFERENCES public.worker_profiles(id),
  CONSTRAINT worker_services_service_id_fkey FOREIGN KEY (service_id) REFERENCES public.services(id)
);